import smtplib
from email.message import EmailMessage
from config import *

def send_alert(
    case_id,
    ip,
    user,
    severity,
    risk,
    intel_reason,
    malware_flag,
    vt_flag,
    correlation_reason
):
    if not ENABLE_EMAIL:
        return

    subject = f"[SOAR ALERT] {risk} | Case {case_id[:8]}"

    body = f"""
===============================
üö® SECURITY INCIDENT ALERT
===============================

üìå Case ID        : {case_id}
üïí Time (UTC)     : {__import__('datetime').datetime.utcnow().isoformat()}

-------------------------------
üîç ALERT DETAILS
-------------------------------
‚Ä¢ Severity Level : {severity}
‚Ä¢ Risk Level     : {risk}
‚Ä¢ Source IP      : {ip}
‚Ä¢ Username       : {user or 'N/A'}

-------------------------------
üåç THREAT INTELLIGENCE
-------------------------------
‚Ä¢ Reputation     : {intel_reason}

-------------------------------
‚ò£Ô∏è MALWARE ANALYSIS
-------------------------------
‚Ä¢ Malware Found  : {"YES" if malware_flag else "NO"}
‚Ä¢ VirusTotal Hit : {"YES" if vt_flag else "NO"}

-------------------------------
üîó CORRELATION / APT CONTEXT
-------------------------------
‚Ä¢ Attack Pattern : {correlation_reason or "Single-stage / Unknown"}

-------------------------------
ü§ñ SOAR MODE
-------------------------------
‚Ä¢ Response Mode  : {RESPONSE_MODE}
‚Ä¢ Auto Block     : {"YES" if risk == AUTO_BLOCK_RISK else "NO"}

-------------------------------
üõ°Ô∏è STATUS
-------------------------------
‚Ä¢ Case Status    : OPEN
‚Ä¢ Action Taken   : {"Automatic containment initiated" if risk == AUTO_BLOCK_RISK else "Monitoring / Analyst review"}

===============================
This alert was generated by
Mini-SOAR (Wazuh + TI + Automation)
===============================
"""

    msg = EmailMessage()
    msg["Subject"] = subject
    msg["From"] = EMAIL_SENDER
    msg["To"] = EMAIL_RECEIVER
    msg.set_content(body)

    try:
        with smtplib.SMTP(SMTP_SERVER, SMTP_PORT, timeout=10) as s:
            s.starttls()
            s.login(EMAIL_SENDER, EMAIL_PASSWORD)
            s.send_message(msg)
            print("[MAIL] Detailed SOC alert sent")

    except Exception as e:
        print("[MAIL ERROR]", e)
